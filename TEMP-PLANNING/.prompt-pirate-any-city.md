# Task: Implement Auto-Pirate from Non-Capital City Feature

## Context
Repository: ikabotFork
Base branch: claude/analysis-and-documentation-011CUz15BfEZzx2rdz5LF9Mk
Create new branch: claude/feat-pirate-from-any-city-<SESSION_ID>

Related docs: TEMP-PLANNING/issue-02-autopirate-bugs.md (see feature request section)

Current behavior: autoPirate only uses capital city's pirate fortress
Required: Use highest-level pirate fortress from ANY city

## Critical Rules

1. MINIMAL CHANGES - modify only autoPirate.py
2. NO NEW DEPENDENCIES - use only existing imports
3. RESPECT EXISTING PATTERNS:
   - position=17 is CORRECT (game mechanic, don't change)
   - Bare except clauses are INTENTIONAL (graceful recovery, don't change)
   - Use existing helpers: getIdsOfCities, getCity
4. MATCH EXISTING CODE STYLE - look at autoPirate.py and copy formatting, naming, patterns

## Requirements

### Find all pirate fortresses:
- Check ALL user cities for pirate fortress at position=17
- Get building level for each fortress
- Track: city_id, city_name, fortress_level

### Selection logic (in order):

```
if no fortresses found:
    print error message
    exit gracefully (don't crash)

if capital has fortress AND other cities have fortresses:
    find highest level
    if multiple cities tied at highest level:
        if capital is in the tie:
            use capital (tie-breaker)
        else:
            use lowest city_id (deterministic)
    else:
        use city with highest level

if only capital has fortress:
    use capital

if only other cities have fortress:
    use highest (if tie: lowest city_id)
```

### Test cases (all must work):
1. Capital level 5, other level 3 → uses capital
2. Capital level 3, other level 5 → uses other
3. Capital level 5, other level 5 → uses capital (tie-breaker)
4. Only capital has fortress → uses capital
5. Only other city has fortress → uses other
6. No fortresses anywhere → prints error, exits gracefully
7. Multiple others tied (5, 5, 3) → uses lowest city_id of the 5s

## Implementation Steps

### Step 1: Read these files first
- ikabot/function/autoPirate.py (entire file - understand current flow)
- ikabot/helpers/pedirInfo.py (see getIdsOfCities pattern)
- ikabot/helpers/getJson.py (see getCity pattern)

### Step 2: Create helper function

Add this new function in autoPirate.py (before autoPirate function):

```python
def findBestPirateFortress(session):
    """Find city with highest-level pirate fortress across all cities"""
    from ikabot.helpers.pedirInfo import getIdsOfCities
    from ikabot.helpers.getJson import getCity

    # Get all cities
    (ids, cities) = getIdsOfCities(session)

    # Find fortresses in each city
    fortresses = []
    capital_city = None

    for city_id in ids:
        html = session.get(city_url + city_id)
        city = getCity(html)

        # Check if this is capital (first city is capital typically)
        # You'll need to figure out how to identify capital from existing code

        # Check for pirate fortress at position 17
        pirate_building = [b for b in city['position']
                          if b.get('building') == 'pirateFortress'
                          and b.get('position') == '17']

        if pirate_building:
            level = pirate_building[0].get('level', 0)
            fortresses.append({
                'city': city,
                'level': level,
                'is_capital': # determine this
            })

    # Selection logic here
    # Return best city or None
```

### Step 3: Find insertion point

Locate around line 193-201 in autoPirate.py where it gets the capital city.
Replace that section with call to findBestPirateFortress().

Current code looks like:
```python
html = session.get()
city = getCity(html)
```

Change to:
```python
city = findBestPirateFortress(session)
if city is None:
    print("No pirate fortress found in any city!")
    print("Build a pirate fortress to use Auto-Pirate.")
    event.set()
    return
print("Using pirate fortress in {}".format(city['cityName']))
```

### Step 4: Match existing style

Look at autoPirate.py and copy:
- Variable naming (camelCase for locals, descriptive)
- Print statement format
- Comment style (sparse)
- Error handling (try/except patterns)
- Indentation and spacing

## Commit Message

```
Add capital city preference for pirate fortress selection

Modified autoPirate to select highest-level pirate fortress across
all cities instead of only using capital city.

Selection logic:
- Scans all cities for pirate fortresses
- Uses highest level fortress found
- Tie-breaker: prefers capital if tied for highest
- Deterministic: uses lowest city_id for non-capital ties
- Graceful error if no fortresses found

File modified: ikabot/function/autoPirate.py
No new dependencies added.
```

## Success Criteria

- All 7 test cases pass
- Only autoPirate.py modified (or minimal changes elsewhere)
- No new dependencies
- Matches existing code style
- No crashes when no fortress
- User sees which city is being used

## Start Here

1. Read autoPirate.py completely
2. Identify where capital city is currently selected
3. Understand existing patterns (how to get cities, check buildings)
4. Implement findBestPirateFortress() function
5. Integrate into existing flow
6. Test all 7 cases
7. Commit to branch: claude/feat-pirate-from-any-city-<SESSION_ID>

Focus: Minimal change, no dependencies, match existing patterns.
